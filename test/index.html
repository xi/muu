<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Mocha Tests</title>
    <link href="../lib/mocha/mocha.css" rel="stylesheet" />

    <!--[if IE 8]>
    <script src="../lib/ie8/build/ie8.js"></script>
    <script src="../lib/es5-shim/es5-shim.js"></script>
    <![endif]-->
    <script src="../lib/dom4/build/dom4.js"></script>
</head>
<body>
    <div id="mocha"></div>

    <script src="../lib/mocha/mocha.js"></script>
    <script src="../lib/expect.js/index.js"></script>
    <script src="../lib/sinon-js/sinon.js"></script>
    <script src="../lib/requirejs/require.js"></script>
    <script
        src="../lib/blanket/dist/qunit/blanket.js"
        data-cover-adapter="../lib/blanket/src/adapters/mocha-blanket.js"
        data-cover-flags="branchTracking">
    </script>

    <script>
        mocha.setup('bdd');

        if (location.search.indexOf('coverage=no') === -1) {
            blanket.options('filter', 'muu');
        } else {
            blanket.options('filter', 'nonexistent');
        }

        require({
            baseUrl: '../src/'
        }, [
            'muu-dom-helpers',
            '../test/test-dom-helpers',
            '../test/test-js-helpers.js',
            '../test/test-template.js',
            '../test/test-update-dom',
            '../test/test-search',
            '../test/test-directive',
            '../test/test-registry'
        ], function ($) {
            $.DELAY = 5;

            mocha.checkLeaks();
            mocha.globals(['mochaResulsts']);
            var runner = mocha.run();

            // generate output for saucelabs
            var flattenTitles = function(test) {
                var titles = [];
                while (test.parent.title) {
                    titles.push(test.parent.title);
                    test = test.parent;
                }
                return titles.reverse();
            };

            var failedTests = [];
            var logFailure = function(test, err) {
                failedTests.push({
                    name: test.title,
                    result: false,
                    message: err.message,
                    stack: err.stack,
                    titles: flattenTitles(test)
                });
            };

            runner.on('fail', logFailure);
            runner.on('end', function(){
                window.mochaResults = runner.stats;
                window.mochaResults.reports = failedTests;
            });
        });
    </script>
</body>
</html>
